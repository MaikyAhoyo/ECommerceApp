@model ECommerce.ViewModels.CustomerProductDetailsViewModel
@{
    ViewData["Title"] = Model.Product.Name;
    Layout = "_CustomerLayout";
}

<div class="py-10 pb-20">
    <div class="container mx-auto px-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-8">
            <ol class="flex items-center space-x-2 text-sm">
                <li><a href="/customer/home" class="text-gray-500 hover:text-yellow-500 transition">Inicio</a></li>
                <li class="text-gray-400">/</li>
                <li><a href="/customer/products" class="text-gray-500 hover:text-yellow-500 transition">Productos</a></li>
                <li class="text-gray-400">/</li>
                <li class="text-gray-700 font-medium">@Model.Product.Name</li>
            </ol>
        </nav>

        <div class="grid lg:grid-cols-2 gap-12">
            <!-- Product Image -->
            <div class="lg:sticky lg:top-24 lg:self-start">
                <div class="relative bg-gray-100 rounded-3xl overflow-hidden h-[600px] flex items-center justify-center">
                    @if (!string.IsNullOrEmpty(Model.Product.ImageUrl))
                    {
                        <img src="@Model.Product.ImageUrl" alt="@Model.Product.Name" id="mainImage" class="w-full h-full object-contain">
                    }
                    else
                    {
                        <div class="text-gray-400 text-8xl">
                            <i class="ph ph-image"></i>
                        </div>
                    }
                    @if (Model.Product.Stock == 0)
                    {
                        <div class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center">
                            <span class="bg-red-500 text-white px-10 py-4 text-2xl font-bold rounded-full">AGOTADO</span>
                        </div>
                    }
                </div>
            </div>

            <!-- Product Info -->
            <div>
                <!-- Title & Price -->
                <h1 class="text-4xl font-bold text-gray-800 mb-4">@Model.Product.Name</h1>

                <!-- Rating -->
                <div class="flex items-center gap-3 mb-5">
                    <div class="flex text-yellow-500 text-lg">
                        @for (int i = 1; i <= 5; i++)
                        {
                            if (i <= Math.Floor(Model.AverageRating))
                            {
                                <i class="ph ph-star"></i>
                            }
                            else if (i == Math.Ceiling(Model.AverageRating) && Model.AverageRating % 1 != 0)
                            {
                                <i class="ph ph-star-half-alt"></i>
                            }
                            else
                            {
                                <i class="far ph-star"></i>
                            }
                        }
                        @Model.AverageRating

                    </div>
                    <span class="text-gray-500 text-sm">@Model.AverageRating.ToString("0.0") (@Model.ReviewCount reseñas)</span>
                </div>

                <div class="py-5 my-8 border-t border-b border-gray-200">
                    <span class="block text-5xl font-bold text-green-600 mb-1">$@Model.Product.Price.ToString("N2")</span>
                    <span class="text-gray-500 text-sm">IVA incluido</span>
                </div>

                <!-- Specifications -->
                <div class="grid grid-cols-3 gap-3 mb-8 p-4 bg-gray-100 rounded-xl">
                    <div class="flex items-center gap-3">
                        <i class="ph ph-sketch-logo text-xl text-yellow-500"></i>
                        <div>
                            <span class="block text-xs text-gray-500 uppercase tracking-wide">Metal</span>
                            <span class="block font-semibold text-gray-800 text-sm">@GetMetalName(Model.Product.Metal)</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <i class="ph ph-certificate text-xl text-yellow-500"></i>
                        <div>
                            <span class="block text-xs text-gray-500 uppercase tracking-wide">Pureza</span>
                            <span class="block font-semibold text-gray-800 text-sm">@Model.Product.Purity</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <i class="ph ph-package text-xl text-yellow-500"></i>
                        <div>
                            <span class="block text-xs text-gray-500 uppercase tracking-wide">Disponibilidad</span>
                            <span class="block font-semibold text-sm">
                                @if (Model.Product.Stock > 0)
                                {
                                    <span class="text-green-600">En stock (@Model.Product.Stock)</span>
                                }
                                else
                                {
                                    <span class="text-red-600">Agotado</span>
                                }
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Categories -->
                @if (Model.Categories.Any())
                {
                    <div class="mb-5">
                        <span class="font-semibold text-gray-800 mr-2">Categorías:</span>
                        @foreach (var category in Model.Categories)
                        {
                            <a href="/customer/products?categoryId=@category.Id"
                               class="inline-block px-4 py-1.5 bg-gray-100 text-gray-800 rounded-full text-sm mt-1 mr-2 hover:bg-yellow-500 hover:text-white transition">
                                @category.Name
                            </a>
                        }
                    </div>
                }

                <!-- Description -->
                <div class="my-8">
                    <h6 class="font-bold text-gray-800 mb-4">Descripción</h6>
                    <p class="text-gray-500 leading-relaxed">@Model.Product.Description</p>
                </div>

                <!-- Add to Cart -->
                @if (Model.Product.Stock > 0)
                {
                    <div class="flex gap-4 my-8">
                        <div class="flex items-center border-2 border-gray-200 rounded-xl overflow-hidden">
                            <button type="button" class="w-12 h-12 bg-gray-100 hover:bg-yellow-500 hover:text-white transition" onclick="decreaseQty()">
                                <i class="ph ph-minus"></i>
                            </button>
                            <input type="number" id="quantity" value="1" min="1" max="@Model.Product.Stock"
                                   class="w-20 h-12 text-center border-none font-semibold text-lg" readonly>
                            <button type="button" class="w-12 h-12 bg-gray-100 hover:bg-yellow-500 text-black hover:text-white transition" onclick="increaseQty()">
                                <i class="ph ph-plus"></i>
                            </button>
                        </div>
                        <button type="button" class="flex-1 h-14 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition" onclick="addToCart(@Model.Product.Id)">
                            <i class="ph ph-shopping-cart mr-2"></i>Agregar al Carrito
                        </button>
                    </div>
                }
                else
                {
                    <div class="bg-yellow-100 border border-yellow-300 text-yellow-800 px-4 py-3 rounded-xl">
                        <i class="ph ph-exclamation-triangle mr-2"></i>
                        Este producto está agotado actualmente
                    </div>
                }

                <!-- Trust Badges -->
                <div class="flex flex-col md:flex-row gap-8 my-10 p-6  rounded-xl">
                    <div class="flex items-center gap-3 text-gray-800">
                        <i class="ph ph-shield text-2xl text-green-600"></i>
                        <span>Compra Segura</span>
                    </div>
                    <div class="flex items-center gap-3 text-gray-800">
                        <i class="ph ph-truck text-2xl text-green-600"></i>
                        <span>Envío Gratis</span>
                    </div>
                    <div class="flex items-center gap-3 text-gray-800">
                        <i class="ph ph-arrow-u-down-left text-2xl text-green-600"></i>
                        <span>Devolución 30 días</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="mt-20">
            <h3 class="text-3xl font-bold text-gray-800 mb-8">Reseñas de Clientes</h3>

            @if (Model.Reviews.Any())
            {
                <div class="space-y-5">
                    @foreach (var review in Model.Reviews.Take(5))
                    {
                        <div class="bg-white border border-gray-200 rounded-xl p-6">
                            <div class="flex justify-between mb-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-500 to-orange-500 flex items-center justify-center text-white font-bold text-xl">
                                        @review.User?.Name.Substring(0, 1).ToUpper()
                                    </div>
                                    <div>
                                        <h6 class="font-semibold text-gray-800 mb-1">@review.User?.Name</h6>
                                        <div class="flex text-yellow-500">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <i class="ph ph-star @(i <= review.Rating ? "" : "text-gray-300")"></i>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <span class="text-gray-500 text-sm">@review.CreatedAt.ToString("dd MMM yyyy")</span>
                            </div>
                            <p class="text-gray-500 leading-relaxed">@review.Comment</p>
                        </div>
                    }
                </div>

                @if (User.Identity?.IsAuthenticated == true)
                {
                    <div class="text-center mt-6">
                        <a href="/customer/reviews/create/@Model.Product.Id"
                           class="inline-block px-6 py-3 border-2 border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white rounded-xl font-semibold transition">
                            <i class="ph ph-star mr-2"></i>Escribir una Reseña
                        </a>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-16 bg-gray-100 rounded-xl">
                    <i class="far ph-comment-dots text-6xl text-gray-300 mb-5"></i>
                    <p class="text-gray-500 mb-5">Aún no hay reseñas para este producto</p>
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <a href="/customer/reviews/create/@Model.Product.Id"
                           class="inline-block px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold transition">
                            <i class="ph ph-star mr-2"></i>Sé el primero en opinar
                        </a>
                    }
                </div>
            }
        </div>

        <!-- Related Products -->
        @if (Model.RelatedProducts.Any())
        {
            <div class="mt-20">
                <h3 class="text-3xl font-bold text-gray-800 mb-8">Productos Relacionados</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    @foreach (var product in Model.RelatedProducts.Take(4))
                    {
                        <div class="bg-white border border-gray-200 rounded-xl p-4 text-center hover:shadow-xl transition">
                            <div class="h-52 bg-gray-100 rounded-lg mb-4 overflow-hidden">
                                @if (!string.IsNullOrEmpty(product.ImageUrl))
                                {
                                    <img src="@product.ImageUrl" alt="@product.Name" class="w-full h-full object-contain">
                                }
                                else
                                {
                                    <div class="flex items-center justify-center h-full text-gray-300 text-4xl">
                                        <i class="ph ph-image"></i>
                                    </div>
                                }
                            </div>
                            <h6 class="text-sm text-gray-800 mb-2 min-h-[40px]">@product.Name</h6>
                            <span class="block text-green-600 font-bold text-lg mb-4">$@product.Price.ToString("N2")</span>
                            <a href="/customer/products/details/@product.Id"
                               class="block w-full py-2 border border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white rounded-lg text-sm font-semibold transition">
                                Ver Detalles
                            </a>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

@functions {
    string GetMetalName(string metal)
    {
        return metal switch
        {
            "Gold" => "Oro",
            "Silver" => "Plata",
            "Platinum" => "Platino",
            _ => metal
        };
    }
}

@section Scripts {
    <script>
        let maxQty = @Model.Product.Stock;

        function increaseQty() {
            let qty = parseInt(document.getElementById('quantity').value);
            if (qty < maxQty) {
                document.getElementById('quantity').value = qty + 1;
            }
        }

        function decreaseQty() {
            let qty = parseInt(document.getElementById('quantity').value);
            if (qty > 1) {
                document.getElementById('quantity').value = qty - 1;
            }
        }

        function addToCart(productId) {
            let quantity = parseInt(document.getElementById('quantity').value);

            fetch('/customer/cart/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    productId: productId,
                    quantity: quantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Producto agregado al carrito');
                    updateCartCount();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al agregar al carrito');
            });
        }

        function updateCartCount() {
            // TODO: Implementar actualización del contador
        }
    </script>
}