@model ECommerce.ViewModels.CustomerCartViewModel
@{
    ViewData["Title"] = "Shopping Cart";
    Layout = "_CustomerLayout";
}

<section class="bg-gradient-to-br from-primary via-primary/95 to-primary/90 py-16 relative overflow-hidden">
    <div class="absolute top-0 right-0 w-64 h-64 bg-gold/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
    <div class="container mx-auto px-4 text-center relative z-10 text-white">
        <h1 class="font-playfair text-4xl md:text-5xl font-bold mb-4">Shopping Cart</h1>
        <p class="text-xl text-white/80">Review your items and checkout</p>
    </div>
</section>

<div class="bg-cream py-12 pb-24 min-h-[60vh]">
    <div class="container mx-auto px-4">

        @if (Model.Items != null && Model.Items.Any())
        {
            <div class="grid lg:grid-cols-12 gap-8">

                <div class="lg:col-span-8">
                    <div class="bg-white rounded-3xl p-6 md:p-8 shadow-sm border border-gray-100">

                        <div class="hidden md:grid grid-cols-[100px_1fr_120px_120px_120px_50px] gap-6 text-xs uppercase tracking-wider text-gray-500 font-bold border-b border-gray-100 pb-4 mb-4">
                            <span>Product</span>
                            <span>Description</span>
                            <span class="text-center">Quantity</span>
                            <span class="text-center">Price</span>
                            <span class="text-center">Subtotal</span>
                            <span></span>
                        </div>

                        @foreach (var item in Model.Items)
                        {
                            @await Html.PartialAsync("_ProductCartCardPartial", item)
                        }
                    </div>

                    <div class="mt-6">
                        <a asp-controller="Customer" asp-action="Products" class="inline-flex items-center gap-2 text-gray-500 hover:text-primary font-semibold transition-colors">
                            <i class="ph-bold ph-arrow-left"></i>
                            Continue Shopping
                        </a>
                    </div>
                </div>

                <div class="lg:col-span-4">
                    <div class="bg-white rounded-3xl p-8 shadow-lg border border-gray-100 lg:sticky lg:top-24">
                        <h4 class="font-playfair text-2xl font-bold text-primary mb-6">Order Summary</h4>

                        <div class="space-y-4 text-sm text-gray-600 mb-6">
                            <div class="flex justify-between">
                                <span>Subtotal (@Model.ItemCount items)</span>
                                <span class="font-semibold text-primary">$@Model.Subtotal.ToString("N2")</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Shipping</span>
                                @if (Model.Shipping == 0)
                                {
                                    <span class="text-green-600 font-bold">Free</span>
                                }
                                else
                                {
                                    <span class="font-semibold text-primary">$@Model.Shipping.ToString("N2")</span>
                                }
                            </div>
                            <div class="flex justify-between">
                                <span>Tax (16%)</span>
                                <span class="font-semibold text-primary">$@Model.Tax.ToString("N2")</span>
                            </div>
                        </div>

                        <div class="border-t border-gray-100 pt-6 mb-8">
                            <div class="flex justify-between items-end">
                                <span class="font-playfair font-bold text-xl text-primary">Total</span>
                                <span class="text-3xl font-bold text-gold">$@Model.Total.ToString("N2")</span>
                            </div>
                        </div>

                        <form method="post" 
                              asp-controller="Customer" 
                              asp-action="CreateOrder" 
                              id="createOrderForm">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white h-14 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300 flex items-center justify-center gap-2 group">
                                <i class="ph-bold ph-lock-key"></i>
                                <span>Secure Checkout</span>
                                <i class="ph-bold ph-arrow-right group-hover:translate-x-1 transition-transform"></i>
                            </button>
                        </form>

                        <div class="mt-8 grid grid-cols-3 gap-2 text-center">
                            <div class="flex flex-col items-center gap-1">
                                <i class="ph-fill ph-shield-check text-green-500 text-2xl"></i>
                                <span class="text-[10px] uppercase tracking-wide font-bold text-gray-400">Secure</span>
                            </div>
                            <div class="flex flex-col items-center gap-1">
                                <i class="ph-fill ph-truck text-gold text-2xl"></i>
                                <span class="text-[10px] uppercase tracking-wide font-bold text-gray-400">Fast Ship</span>
                            </div>
                            <div class="flex flex-col items-center gap-1">
                                <i class="ph-fill ph-arrow-u-up-left text-blue-500 text-2xl"></i>
                                <span class="text-[10px] uppercase tracking-wide font-bold text-gray-400">Returns</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="flex flex-col items-center justify-center py-20 text-center">
                <div class="w-32 h-32 bg-white rounded-full shadow-lg flex items-center justify-center mb-8 text-gray-300">
                    <i class="ph-fill ph-shopping-cart text-6xl"></i>
                </div>
                <h3 class="font-playfair text-3xl font-bold text-primary mb-4">Your cart is empty</h3>
                <p class="text-gray-500 text-lg mb-8 max-w-md">Looks like you haven't added any jewelry to your cart yet.</p>
                <a asp-controller="Customer" 
                   asp-action="Products" 
                   class="bg-gold hover:bg-gold-dark text-white px-8 py-4 rounded-full font-bold shadow-lg hover:shadow-xl transition-all duration-300 flex items-center gap-2">
                    <span>Browse Collection</span>
                    <i class="ph-bold ph-arrow-right"></i>
                </a>
            </div>
        }
    </div>
</div>

@functions {
    string GetMetalName(string metal)
    {
        return metal switch
        {
            "Gold" => "Gold",
            "Silver" => "Silver",
            "Platinum" => "Platinum",
            _ => metal
        };
    }
}

@section Scripts {
    <script>
        function updateQuantity(itemId, newQuantity) {
            if (newQuantity < 1) return;

            fetch(`/customer/cart/update/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ quantity: newQuantity })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating quantity');
            });
        }

        function removeItem(itemId) {
            if (!confirm('Remove this item from cart?')) return;

            fetch(`/customer/cart/remove/${itemId}`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error removing item');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error removing item');
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('createOrderForm');
            if (!form) return;

            form.addEventListener('submit', function (e) {
                e.preventDefault();

                const tokenInput = form.querySelector('input[name="__RequestVerificationToken"]');
                const token = tokenInput ? tokenInput.value : null;

                const formData = new FormData();
                if (token) formData.append('__RequestVerificationToken', token);
                formData.append('create', 'true');

                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="ph ph-spinner animate-spin text-xl"></i> Processing...';

                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                .then(async r => {
                    console.log('HTTP', r.status, r.statusText);
                    const text = await r.text();
                    try {
                        return JSON.parse(text);
                    } catch {
                        console.log('Response text (not JSON):', text);
                        return null;
                    }
                })
                .then(data => {
                    console.log('CreateOrder response:', data);
                    if (data && data.success) {
                        if (data.orderId) {
                            window.location.href = `/customer/orders/details/${data.orderId}`;
                            return;
                        }
                        window.location.href = '/customer/orders';
                    } else if (data && !data.success) {
                        alert('Server returned an error: ' + (data.message || 'Unknown error'));
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    } else {
                        window.location.reload();
                    }
                })
                .catch(err => {
                    console.error('AJAX error:', err);
                    alert('Connection error');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                });
            });
        });
    </script>
}