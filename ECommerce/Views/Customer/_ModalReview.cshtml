@model dynamic

<div id="reviewModal" class="hidden fixed inset-0 z-50 flex items-center justify-center" role="dialog" aria-labelledby="reviewModalTitle" aria-modal="true">

    <div class="absolute inset-0 bg-primary/40 backdrop-blur-sm transition-opacity" data-action="close"></div>

    <div class="relative bg-white rounded-3xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden transform transition-all scale-100">

        <div class="bg-white px-8 py-6 border-b border-gray-100 flex items-center justify-between">
            <div>
                <h2 id="reviewModalTitle" class="font-playfair text-2xl font-bold text-primary flex items-center gap-2">
                    <i class="ph-fill ph-star text-gold"></i>
                    Write a review
                </h2>
                <p class="text-sm text-gray-500 mt-1">Share your opinion with other customers</p>
            </div>
            <button type="button" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-50 text-gray-400 hover:bg-red-50 hover:text-red-500 transition-colors" data-action="close" aria-label="Close modal">
                <i class="ph ph-x text-xl"></i>
            </button>
        </div>

        <div class="p-8">

            <div class="bg-cream/50 rounded-2xl p-4 mb-8 flex items-center gap-4 border border-gold/10">
                <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-sm text-gold">
                    <i class="ph-fill ph-package text-2xl"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Product</p>
                    <p class="font-playfair font-bold text-primary text-lg leading-tight">@Model.ProductName</p>
                </div>
            </div>

            <div class="mb-8 text-center">
                <label class="block text-sm font-bold text-gray-700 mb-3">How would you rate this product?</label>
                <div id="starContainer" class="flex justify-center gap-3" role="radiogroup" aria-label="Product rating">
                    @for (int i = 1; i <= 5; i++)
                    {
                        <button type="button" class="star-btn text-4xl text-gray-200 hover:scale-110 transition-transform duration-200 focus:outline-none" data-rating="@i" role="radio" aria-checked="false" aria-label="@i stars">
                            <i class="ph-fill ph-star"></i>
                        </button>
                    }
                </div>
                <input type="hidden" id="reviewRating" value="0">
                <p id="ratingError" class="text-red-500 text-xs font-semibold mt-2 hidden flex items-center justify-center gap-1">
                    <i class="ph-fill ph-warning-circle"></i> Select a rating
                </p>
            </div>

            <div class="mb-2">
                <label for="reviewComment" class="block text-sm font-bold text-gray-700 mb-2">Your Experience</label>
                <div class="relative">
                    <textarea id="reviewComment" placeholder="Tell us what you liked and what we could improve..."
                              class="w-full h-32 p-4 bg-gray-50 border border-gray-200 rounded-2xl focus:outline-none focus:bg-white focus:border-gold focus:ring-4 focus:ring-gold/10 resize-none transition-all text-gray-700 placeholder-gray-400"
                              maxlength="500" aria-describedby="charCount"></textarea>
                    <div class="absolute bottom-3 right-4 text-xs text-gray-400 bg-white/80 px-2 rounded-md backdrop-blur-sm">
                        <span id="charCount">0</span>/500
                    </div>
                </div>
                <p id="commentError" class="text-red-500 text-xs font-semibold mt-2 hidden flex items-center gap-1">
                    <i class="ph-fill ph-warning-circle"></i> The comment cannot be empty
                </p>
            </div>
        </div>

        <div class="px-8 py-6 bg-gray-50 border-t border-gray-100 flex gap-4">
            <button type="button" data-action="close"
                    class="flex-1 px-6 py-3 border border-gray-300 text-gray-600 font-semibold rounded-xl hover:bg-white hover:border-gray-400 hover:text-primary transition-all">
                Cancel
            </button>
            <button type="button" id="submitReviewBtn"
                    class="flex-[2] px-6 py-3 bg-primary text-white font-semibold rounded-xl shadow-lg hover:bg-primary/90 hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed">
                <span>Submit Review</span>
                <i class="ph-bold ph-paper-plane-right"></i>
            </button>
        </div>
    </div>
</div>

<script>
    (function () {
        const productId = @Model.ProductId;
        let selectedRating = 0;

        const CLASS_ACTIVE = ['text-gold', 'scale-110'];
        const CLASS_HOVER = ['text-yellow-300'];
        const CLASS_INACTIVE = ['text-gray-200'];

        function openReviewModal() {
            const modal = document.getElementById('reviewModal');
            if (!modal) return;
            modal.classList.remove('hidden');
            const card = modal.querySelector('.relative');
            card.classList.remove('opacity-0', 'scale-95');

            resetReviewForm();

            setTimeout(() => {
                const textarea = document.getElementById('reviewComment');
                if (textarea) textarea.focus();
            }, 100);
        }

        function closeReviewModal() {
            const modal = document.getElementById('reviewModal');
            if (!modal) return;

            const card = modal.querySelector('.relative');
            card.classList.add('opacity-0', 'scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
                card.classList.remove('opacity-0', 'scale-95');
                resetReviewForm();
            }, 200);
        }

        function resetReviewForm() {
            selectedRating = 0;
            document.getElementById('reviewRating').value = '0';

            const comment = document.getElementById('reviewComment');
            if (comment) comment.value = '';

            const charCount = document.getElementById('charCount');
            if (charCount) charCount.textContent = '0';

            renderStarsUpTo(0, true);

            document.getElementById('ratingError')?.classList.add('hidden');
            document.getElementById('commentError')?.classList.add('hidden');

            const submitBtn = document.getElementById('submitReviewBtn');
            if(submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>Submit Review</span><i class="ph-bold ph-paper-plane-right"></i>';
            }
        }

        function renderStarsUpTo(n, isPermanent = false) {
            document.querySelectorAll('#starContainer .star-btn').forEach((btn, idx) => {
                btn.classList.remove(...CLASS_ACTIVE, ...CLASS_HOVER, ...CLASS_INACTIVE);

                if (idx < n) {
                    if (isPermanent) {
                        btn.classList.add(...CLASS_ACTIVE);
                    } else {
                        btn.classList.add(...CLASS_HOVER);
                    }
                    btn.setAttribute('aria-checked', 'true');
                } else {
                    btn.classList.add(...CLASS_INACTIVE);
                    btn.setAttribute('aria-checked', 'false');
                }
            });
        }

        async function submitReview() {
            const rating = parseInt(document.getElementById('reviewRating').value || '0', 10);
            const comment = (document.getElementById('reviewComment').value || '').trim();

            let hasError = false;
            const ratingError = document.getElementById('ratingError');
            const commentError = document.getElementById('commentError');

            if (rating === 0) {
                ratingError?.classList.remove('hidden');
                hasError = true;
            } else {
                ratingError?.classList.add('hidden');
            }

            if (comment.length === 0) {
                commentError?.classList.remove('hidden');
                hasError = true;
            } else {
                commentError?.classList.add('hidden');
            }

            if (hasError) return;

            const submitBtn = document.getElementById('submitReviewBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="ph ph-spinner animate-spin text-xl"></i> Enviando...';
            }

            const payload = {
                productId: productId,
                rating: rating,
                comment: comment
            };

            try {
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json().catch(() => ({}));

                if (response.ok) {
                    if (typeof notificationModal !== 'undefined') {
                        notificationModal.success('Thanks!', 'Your review has been published.', () => {
                            closeReviewModal();
                            location.reload();
                        });
                    } else {
                        alert('Review submitted successfully!');
                        closeReviewModal();
                        location.reload();
                    }
                } else {
                    const msg = data?.message || 'Error submitting review';
                    if (typeof notificationModal !== 'undefined') {
                        notificationModal.error('Error', msg);
                    } else {
                        alert(msg);
                    }
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<span>Submit Review</span><i class="ph-bold ph-paper-plane-right"></i>';
                    }
                }
            } catch (err) {
                console.error('Network error:', err);
                if (typeof notificationModal !== 'undefined') {
                    notificationModal.error('Connection', 'Error connecting to the server.');
                } else {
                    alert('Connection error');
                }
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<span>Submit Review</span><i class="ph-bold ph-paper-plane-right"></i>';
                }
            }
        }

        function initReviewModal() {
            const modal = document.getElementById('reviewModal');
            if (!modal) return;

            const starButtons = Array.from(document.querySelectorAll('#starContainer .star-btn'));
            const starContainer = document.getElementById('starContainer');
            const commentEl = document.getElementById('reviewComment');
            const charCount = document.getElementById('charCount');
            const submitBtn = document.getElementById('submitReviewBtn');

            starButtons.forEach((btn, index) => {
                const ratingValue = index + 1;

                btn.addEventListener('click', () => {
                    selectedRating = ratingValue;
                    document.getElementById('reviewRating').value = String(selectedRating);
                    renderStarsUpTo(selectedRating, true);
                    document.getElementById('ratingError')?.classList.add('hidden');
                });

                btn.addEventListener('mouseenter', () => {
                    renderStarsUpTo(ratingValue, false);
                });
            });

            starContainer?.addEventListener('mouseleave', () => {
                if (selectedRating > 0) {
                    renderStarsUpTo(selectedRating, true);
                } else {
                    renderStarsUpTo(0, true);
                }
            });

            if (commentEl && charCount) {
                commentEl.addEventListener('input', () => {
                    charCount.textContent = String(commentEl.value.length);
                    if (commentEl.value.trim().length > 0) {
                        document.getElementById('commentError')?.classList.add('hidden');
                    }
                });
            }

            submitBtn?.addEventListener('click', submitReview);

            modal.querySelectorAll('[data-action="close"]').forEach(btn => {
                btn.addEventListener('click', closeReviewModal);
            });

            modal.addEventListener('click', (e) => {
                if (e.target.getAttribute('data-action') === 'close' || e.target === modal) {
                    closeReviewModal();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                    closeReviewModal();
                }
            });

            window.openReviewModal = openReviewModal;
            window.closeReviewModal = closeReviewModal;
        }

        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            initReviewModal();
        } else {
            document.addEventListener('DOMContentLoaded', initReviewModal);
        }
    })();
</script>