@model IEnumerable<ECommerce.Models.Entities.User>
@{
    ViewData["Title"] = "Users Management";
    Layout = "_AdminLayout";

    var currentSearch = Context.Request.Query["search"].ToString();
    var currentRole = Context.Request.Query["role"].ToString();
}

<!-- Page Header -->
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
    <div>
        <div class="flex items-center space-x-3 mb-2">
            <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                <i class="ph-fill ph-users text-blue-600 text-xl"></i>
            </div>
            <h1 class="font-playfair text-3xl font-bold text-primary">Users</h1>
        </div>
        <p class="text-gray-600">Manage system users and permissions</p>
    </div>
    <a href="/admin/users/create" class="inline-flex items-center space-x-2 bg-blue-600 hover:bg-blue-800 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl">
        <i class="ph ph-plus-circle text-xl"></i>
        <span>New User</span>
    </a>
</div>

<!-- Filters & Results Info -->
<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden mb-8">
    <!-- Filters -->
    <div class="p-6 border-b border-gray-100">
        <form method="get" action="/admin/users" class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <input type="hidden" name="page" value="1">
            <input type="hidden" name="pageSize" value="@ViewBag.PageSize">

            <!-- Search -->
            <div class="md:col-span-2">
                <div class="relative">
                    <input type="text"
                           name="search"
                           value="@currentSearch"
                           placeholder="Search by user ID or name..."
                           class="w-full rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none px-4 py-2.5 pr-10 transition-all">
                    <i class="ph ph-magnifying-glass absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>

            <!-- Role Filter -->
            <div class="md:col-span-2">
                <select name="role"
                        class="w-full rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none px-4 py-2.5 transition-all">
                    <option value="">All Users</option>
                    <option value="Admin" @(currentRole == "Admin" ? "selected" : "")>Admin</option>
                    <option value="Vendor" @(currentRole == "Vendor" ? "selected" : "")>Vendor</option>
                    <option value="Customer" @(currentRole == "Customer" ? "selected" : "")>Customer</option>
                </select>
            </div>

            <!-- Submit Button -->
            <div>
                <button type="submit"
                        class="w-full bg-blue-50 hover:bg-blue-500 text-blue-600 hover:text-white border-2 border-blue-500 px-6 py-2.5 rounded-xl font-semibold transition-all duration-300 flex items-center justify-center space-x-2">
                    <i class="ph ph-funnel-simple"></i>
                    <span>Filter</span>
                </button>
            </div>
        </form>
    </div>

    <!-- Results Info & Page Size Selector -->
    <div class="px-6 py-4 bg-gray-50 flex flex-col sm:flex-row justify-between items-center gap-4">
        <div class="flex items-center space-x-2">
            <i class="ph ph-shopping-cart text-blue-600"></i>
            <span class="text-sm text-gray-600">
                Showing <span class="font-semibold text-primary">@((ViewBag.CurrentPage - 1) * ViewBag.PageSize + 1)</span>
                to <span class="font-semibold text-primary">@Math.Min(ViewBag.CurrentPage * ViewBag.PageSize, ViewBag.TotalItems)</span>
                of <span class="font-semibold text-primary">@ViewBag.TotalItems</span> users
            </span>
        </div>

        <form method="get" asp-action="Users" class="flex items-center space-x-2">
            <input type="hidden" name="search" value="@currentSearch">
            <input type="hidden" name="role" value="@currentRole">
            <input type="hidden" name="page" value="1">

            <label class="text-sm text-gray-600 font-medium">Items per page:</label>
            <select name="pageSize"
                    onchange="this.form.submit()"
                    class="rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none px-3 py-1.5 text-sm font-medium transition-all">
                <option value="5" @(ViewBag.PageSize == 5 ? "selected" : "")>5</option>
                <option value="10" @(ViewBag.PageSize == 10 ? "selected" : "")>10</option>
                <option value="20" @(ViewBag.PageSize == 20 ? "selected" : "")>20</option>
                <option value="50" @(ViewBag.PageSize == 50 ? "selected" : "")>50</option>
            </select>
        </form>
    </div>
</div>

<!-- Users Table -->
<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
    @if (Model != null && Model.Any())
    {
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-100">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">User</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Email</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Role</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Joined</th>
                        <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    @foreach (var user in Model)
                    {
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-@GetRoleColor(user.Role)-400 to-@GetRoleColor(user.Role)-600 rounded-full flex items-center justify-center text-white font-semibold">
                                        @user.Name.Substring(0, 1).ToUpper()
                                    </div>
                                    <div>
                                        <p class="font-semibold text-primary">@user.Name</p>
                                        <p class="text-xs text-gray-500">ID: @user.Id</p>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-gray-700">@user.Email</span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold @GetRoleBadgeClasses(user.Role)">
                                    <i class="ph-fill ph-@GetRoleIcon(user.Role) mr-1"></i>
                                    @user.Role
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-gray-600 text-sm">@user.CreatedAt.ToString("MMM dd, yyyy")</span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center justify-center space-x-2">
                                    <button onclick="changeRole(@user.Id, '@user.Name', '@user.Role')"
                                            class="inline-flex items-center justify-center w-9 h-9 bg-purple-100 hover:bg-purple-500 text-purple-600 hover:text-white rounded-lg transition-all duration-300"
                                            title="Change Role">
                                        <i class="ph ph-user-gear text-lg"></i>
                                    </button>
                                    <button onclick="deleteUser(@user.Id, '@user.Name')"
                                            class="inline-flex items-center justify-center w-9 h-9 bg-red-100 hover:bg-red-500 text-red-600 hover:text-white rounded-lg transition-all duration-300"
                                            title="Delete User">
                                        <i class="ph ph-user-minus text-lg"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (ViewBag.TotalPages > 1)
        {
            <div class="px-6 py-4 border-t border-gray-100 bg-gray-50">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="text-sm text-gray-600">
                        Page <span class="font-semibold text-primary">@ViewBag.CurrentPage</span> of <span class="font-semibold text-primary">@ViewBag.TotalPages</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        @if (ViewBag.CurrentPage > 2)
                        {
                            <a href="@GetPageUrl(1)"
                               class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-500 hover:text-white transition-all"
                               title="First Page">
                                <i class="ph ph-caret-double-left"></i>
                            </a>
                        }
                        @if (ViewBag.CurrentPage > 1)
                        {
                            <a href="@GetPageUrl(ViewBag.CurrentPage - 1)"
                               class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-500 hover:text-white transition-all"
                               title="Previous">
                                <i class="ph ph-caret-left"></i>
                            </a>
                        }
                        @{
                            var startPage = Math.Max(1, ViewBag.CurrentPage - 2);
                            var endPage = Math.Min(ViewBag.TotalPages, ViewBag.CurrentPage + 2);
                        }

                        @for (int i = startPage; i <= endPage; i++)
                        {
                            if (i == ViewBag.CurrentPage)
                            {
                                <div class="w-10 h-10 flex items-center justify-center rounded-xl bg-blue-500 text-white font-bold shadow-lg">@i</div>
                            }
                            else
                            {
                                <a href="@GetPageUrl(i)"
                                   class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-500 hover:text-white transition-all font-medium">@i</a>
                            }
                        }
                        @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                        {
                            <a href="@GetPageUrl(ViewBag.CurrentPage + 1)"
                               class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-500 hover:text-white transition-all"
                               title="Next">
                                <i class="ph ph-caret-right"></i>
                            </a>
                        }
                        @if (ViewBag.CurrentPage < ViewBag.TotalPages - 1)
                        {
                            <a href="@GetPageUrl(ViewBag.TotalPages)"
                               class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-500 hover:text-white transition-all"
                               title="Last Page">
                                <i class="ph ph-caret-double-right"></i>
                            </a>
                        }
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="text-center py-20">
            <div class="w-24 h-24 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i class="ph ph-user text-gray-300 text-6xl"></i>
            </div>
            <h3 class="font-playfair text-2xl font-bold text-primary mb-2">No Users Found</h3>
            <p class="text-gray-600 mb-8">
                @if (!string.IsNullOrEmpty(currentSearch) || !string.IsNullOrEmpty(currentRole))
                {
                    <span>No users match your filters. Try adjusting your search.</span>
                }
                else
                {
                    <span>No users have been created.</span>
                }
            </p>
            @if (!string.IsNullOrEmpty(currentSearch) || !string.IsNullOrEmpty(currentRole))
            {
                <a href="/admin/users" class="inline-flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-semibold transition-all duration-300">
                    <i class="ph ph-arrow-clockwise"></i>
                    <span>Clear Filters</span>
                </a>
            }
        </div>
    }
</div>

<!-- Change Role Modal -->
<div id="roleModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden transform transition-all scale-95 opacity-0" id="modalContent">

        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                        <i class="ph-fill ph-user-gear text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white">Change User Role</h3>
                </div>
                <button onclick="closeModal()" class="text-white/80 hover:text-white transition-colors">
                    <i class="ph ph-x text-2xl"></i>
                </button>
            </div>
        </div>

        <!-- Modal Body -->
        <form id="roleForm" method="post" class="p-6 space-y-6">
            @Html.AntiForgeryToken()
            <input type="hidden" name="userId" id="userId">

            <div class="bg-purple-50 border border-purple-200 rounded-xl p-4">
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <i class="ph-fill ph-user-circle text-purple-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-purple-800">
                            Changing role for: <strong id="userName" class="text-purple-900"></strong>
                        </p>
                        <p class="text-xs text-purple-600 mt-1">
                            Current role: <span id="currentRole" class="font-semibold"></span>
                        </p>
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-sm font-semibold text-primary mb-2">New Role</label>
                <select name="role"
                        class="w-full rounded-xl border-2 border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 outline-none px-4 py-3 transition-all">
                    <option value="Customer">Customer</option>
                    <option value="Vendor">Vendor</option>
                    <option value="Admin">Admin</option>
                </select>
            </div>

            <div class="flex space-x-3">
                <button type="button"
                        onclick="closeModal()"
                        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 rounded-xl transition-all duration-300">
                    Cancel
                </button>
                <button type="submit"
                        class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl">
                    Update Role
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete User Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden transform transition-all scale-95 opacity-0" id="deleteModalContent">

        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-red-500 to-red-600 px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                        <i class="ph-fill ph-user-minus text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white">Confirm User Deletion</h3>
                </div>
                <button onclick="closeDeleteModal()" class="text-white/80 hover:text-white transition-colors">
                    <i class="ph ph-x text-2xl"></i>
                </button>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="p-6">
            <p class="text-gray-700 mb-4">
                Are you sure you want to delete the user
                <strong id="deleteUserName" class="text-primary"></strong>?
            </p>

            <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <i class="ph-fill ph-warning-circle text-red-600 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm text-red-800 font-medium">Warning</p>
                        <p class="text-xs text-red-700 mt-1">
                            This action will permanently remove this user and all their related data.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Modal Actions -->
            <div class="flex space-x-3">
                <button onclick="closeDeleteModal()"
                        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 rounded-xl transition-all duration-300">
                    Cancel
                </button>

                <form id="deleteForm" method="post" class="flex-1">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="deleteUserId" name="id" />
                    <button type="submit"
                            class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl">
                        Delete User
                    </button>
                </form>
            </div>
        </div>
    </div>
</div> 

@functions {
    string GetRoleColor(string role)
    {
        return role switch
        {
            "Admin" => "red",
            "Vendor" => "blue",
            "Customer" => "green",
            _ => "gray"
        };
    }

    string GetRoleBadgeClasses(string role)
    {
        return role switch
        {
            "Admin" => "bg-red-100 text-red-700",
            "Vendor" => "bg-blue-100 text-blue-700",
            "Customer" => "bg-green-100 text-green-700",
            _ => "bg-gray-100 text-gray-700"
        };
    }

    string GetRoleIcon(string role)
    {
        return role switch
        {
            "Admin" => "shield-check",
            "Vendor" => "storefront",
            "Customer" => "user-circle",
            _ => "user"
        };
    }

    string GetPageUrl(int page)
    {
        var currentSearch = Context.Request.Query["search"].ToString();
        var currentRole = Context.Request.Query["role"].ToString();
        var pageSize = ViewBag.PageSize;

        var queryParams = new List<string>
        {
            $"page={page}",
            $"pageSize={pageSize}"
        };

        if (!string.IsNullOrEmpty(currentSearch))
            queryParams.Add($"search={Uri.EscapeDataString(currentSearch)}");
        if (!string.IsNullOrEmpty(currentRole))
            queryParams.Add($"role={currentRole}");

        return $"/admin/users?{string.Join("&", queryParams)}";
    }
}

@section Scripts {
    <script>
        function changeRole(id, name, currentRole) {
            document.getElementById('userId').value = id;
            document.getElementById('userName').textContent = name;
            document.getElementById('currentRole').textContent = currentRole;

            const modal = document.getElementById('roleModal');
            const modalContent = document.getElementById('modalContent');
            const form = document.getElementById('roleForm');

            form.action = `/admin/users/change-role/${id}`;

            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function deleteUser(id, name) {
            document.getElementById('deleteUserId').value = id;
            document.getElementById('deleteUserName').textContent = name;

            const modal = document.getElementById('deleteModal');
            const modalContent = document.getElementById('deleteModalContent');
            const form = document.getElementById('deleteForm');

            form.action = `/admin/users/delete/${id}`;

            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('roleModal');
            const modalContent = document.getElementById('modalContent');
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function closeDeleteModal() {
            const modal = document.getElementById('deleteModal');
            const modalContent = document.getElementById('deleteModalContent');
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        document.getElementById('roleModal')?.addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });
        document.getElementById('deleteModal')?.addEventListener('click', e => { if (e.target === e.currentTarget) closeDeleteModal(); });
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                closeModal();
                closeDeleteModal();
            }
        });
    </script>
}